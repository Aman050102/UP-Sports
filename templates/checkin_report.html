{% load static %}
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>รายงานผู้เข้าใช้สนาม – ดู/ค้นหา/ดาวน์โหลด</title>
  <meta name="color-scheme" content="light dark">
  <link rel="icon" href="{% static 'img/Logo_of_University_of_Phayao.svg.png' %}" type="image/png">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>

  <!-- Export libs -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.min.js" defer></script>

  <style>
    :root{
      --purple:#c08af6; --purple-100:#e9d8ff;
      --bg:#efe8f7; --card:#fff; --text:#1d1b22; --muted:#6a6570; --divider:#ece7f3;
      --shadow:0 10px 30px rgba(55,36,107,.12);
      --outdoor:#2e7d32; --badminton:#1565c0; --pool:#0f766e; --track:#ef6c00;
      --pill:#ead9ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans Thai",Roboto,Arial,sans-serif;
      color:var(--text);
      background:linear-gradient(180deg,var(--purple) 0 90px, var(--bg) 90px 100%)
    }
    header{height:90px;display:flex;align-items:center;padding:0 18px;color:#fff;font-weight:900}
    .brand img{height:120px;object-fit:contain}
    main{min-height:calc(100% - 90px); padding:18px; display:grid; gap:18px}
    .card{background:var(--card); border-radius:22px; box-shadow:var(--shadow); padding:16px}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input[type="date"], select, input[type="text"], button{
      padding:10px 12px; border:1px solid var(--divider); border-radius:12px; font-weight:600; background:#fff
    }
    button{cursor:pointer}

    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border:1px solid var(--divider); border-radius:999px; background:#fff; font-weight:700
    }
    .chip small{opacity:.85; font-weight:800}
    .chip[data-k="all"]{background:var(--pill)}
    .chip[data-k="outdoor"]{color:var(--outdoor)}
    .chip[data-k="badminton"]{color:var(--badminton)}
    .chip[data-k="pool"]{color:var(--pool)}
    .chip[data-k="track"]{color:var(--track)}
    .chip.selected{outline:3px solid currentColor; outline-offset:2px}

    /* ===== แถวกราฟ ===== */
    .chart-row{
      display:grid; grid-template-columns: 1fr; gap:16px;
      align-items:center; justify-items:center;
    }
    /* ปุ่ม Export ชิดซ้าย */
    .chart-actions{
      width:100%;
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-start;
    }
    /* ทำกราฟ “กลมและอยู่กลาง” */
    .chart-wrap{
      width:100%; display:flex; justify-content:center;
    }
    .chart-wrap canvas{
      width:360px;           /* กราฟเล็กลง */
      aspect-ratio:1/1;      /* สัดส่วนจานกลม/สี่เหลี่ยมตามชนิดกราฟ */
      max-width:90vw;
    }

    .stats{display:grid; grid-template-columns:repeat(5,1fr); gap:12px}
    .stat{background:#fff; border:1px solid var(--divider); border-radius:16px; padding:14px}
    .stat small{color:var(--muted)}
    .stat b{font-size:28px}

    .table-card{padding:0; overflow:hidden}
    .table-headband{
      background:#d4b5fa; color:#fff; font-weight:900;
      padding:14px 18px; border-top-left-radius:22px; border-top-right-radius:22px
    }
    .table-wrap{max-height:48vh; overflow:auto; border-top:1px solid var(--divider)}
    table{width:100%; border-collapse:collapse; background:#fff}
    thead th{position:sticky; top:0; background:#f3effa}
    th,td{padding:10px 12px; border-bottom:1px solid var(--divider); text-align:left; font-size:14px}
    tbody tr:hover{background:#faf9fc}

    .bigbox{
      background:#fff; border:1px solid var(--divider); border-radius:22px; padding:18px 22px;
      font-size:22px; font-weight:800; box-shadow:var(--shadow)
    }
    .bigbox b{font-size:40px; display:block; margin-top:4px}

    @media(max-width:1100px){
      .stats{grid-template-columns:repeat(2,1fr)}
    }
    @media(prefers-color-scheme:dark){
      :root{--bg:#1f1a29; --card:#221d2e; --text:#f6f1ff; --muted:#c7bfd3; --divider:#3a304b}
      thead th{background:#2d2540}
      .table-headband{background:#7b5bb0}
    }
  </style>
</head>
<body>
  <header class="topbar" aria-label="University Bar">
    <div class="brand">
      <img src="{% static 'img/logoDSASMART.png' %}" alt="DSA" class="brand-logo">
    </div>
  </header>

  <main>
    <section class="card">
      <div class="toolbar">
        <label>ช่วงวันที่:
          <input type="date" id="from"> -
          <input type="date" id="to">
        </label>

        <!-- โหมดเวลาของกราฟ -->
        <label>มุมมองกราฟ:
          <select id="timeMode">
            <option value="hour">รายชั่วโมง</option>
            <option value="day">รายวัน</option>
            <option value="month">รายเดือน</option>
            <option value="year">รายปี</option>
          </select>
        </label>

        <label>สนาม:
          <input type="text" id="q" placeholder="ชื่อสนาม" style="min-width:200px">
        </label>
        

        <span style="flex:1"></span>

        <div class="chips" id="chips">
          <span class="chip selected" data-k="all"><small>ทั้งหมด</small></span>
          <span class="chip" data-k="outdoor" style="border-color:var(--outdoor)"><small>สนามกลางแจ้ง</small></span>
          <span class="chip" data-k="badminton" style="border-color:var(--badminton)"><small>สนามแบดมินตัน</small></span>
          <span class="chip" data-k="track" style="border-color:var(--track)"><small>ลู่และลาน</small></span>
          <span class="chip" data-k="pool" style="border-color:var(--pool)"><small>สระว่ายน้ำ</small></span>
        </div>
      </div>

      <!-- แถวกราฟ -->
      <div class="chart-row" id="chartRow">
        <div class="chart-actions">
          <button id="btnExcel">ดาวน์โหลด Excel</button>
          <button id="btnPDF">ดาวน์โหลด PDF</button>
          <button id="btnDoc">ดาวน์โหลด DOCX</button>
          <button id="btnPrint">พิมพ์เป็น PDF (บราวเซอร์)</button>
        </div>
        <div class="chart-wrap">
          <canvas id="chart" aria-label="chart"></canvas>
        </div>
      </div>
    </section>

    <section class="bigbox" id="bigbox">
      สนามทั้งหมด
      <b id="bigcount">0</b>
    </section>

    <!-- 5 กล่องเรียงในแถวเดียว -->
    <section class="card stats" id="stats">
      <div class="stat"><small>รวมรายการ</small><div><b id="st-total">0</b></div></div>
      <div class="stat"><small>สนามกลางแจ้ง</small><div><b id="st-outdoor">0</b></div></div>
      <div class="stat"><small>สนามแบดมินตัน</small><div><b id="st-badminton">0</b></div></div>
      <div class="stat"><small>สระว่ายน้ำ</small><div><b id="st-pool">0</b></div></div>
      <div class="stat"><small>ลู่ - ลาน</small><div><b id="st-track">0</b></div></div>
    </section>

    <section class="card table-card">
      <div class="table-headband" id="tableHeadText">
        เวลา&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;วันที่ (session)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;สนาม
      </div>
      <div class="table-wrap">
        <table id="table" aria-label="รายการเข้าใช้">
          <thead id="thead">
            <tr><th>เวลา</th><th>วันที่ (session)</th><th>สนาม</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const $  = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
    const FAC_NAME = { outdoor:'สนามกลางแจ้ง', badminton:'สนามแบดมินตัน', pool:'สระว่ายน้ำ', track:'ลู่และลาน' };
    const COLORS   = { outdoor:getCss('--outdoor'), badminton:getCss('--badminton'), pool:getCss('--pool'), track:getCss('--track') };
    function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
    function ymd(d){ return new Date(d).toISOString().slice(0,10); }
    function fmtTime(iso){ const d = new Date(iso); return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
    const today = ymd(new Date()); $('#from').value=today; $('#to').value=today;

    let rows = [];               // หลังกรองชื่อ
    let facilityFilter = 'all';  // all | outdoor | badminton | pool | track
    let chart;

    // ===== helpers: bucket =====
    function pad2(n){return String(n).padStart(2,'0');}
    function bucketKey(date, mode){
      const y = date.getFullYear(), m = pad2(date.getMonth()+1), d = pad2(date.getDate());
      if(mode==='hour') return `${pad2(date.getHours())}:00`;
      if(mode==='day')  return `${y}-${m}-${d}`;
      if(mode==='month')return `${y}-${m}`;
      return String(y); // year
    }
    function sortedLabels(mode, fromISO, toISO){
      const from = new Date(fromISO), to = new Date(toISO);
      const labels = [];
      const cur = new Date(from);
      if(mode==='hour'){
        for(let h=0; h<24; h++) labels.push(pad2(h)+':00');
      }else if(mode==='day'){
        while(cur <= to){ labels.push(`${cur.getFullYear()}-${pad2(cur.getMonth()+1)}-${pad2(cur.getDate())}`); cur.setDate(cur.getDate()+1); }
      }else if(mode==='month'){
        while(cur <= to){ labels.push(`${cur.getFullYear()}-${pad2(cur.getMonth()+1)}`); cur.setMonth(cur.getMonth()+1); }
      }else{
        while(cur.getFullYear() <= to.getFullYear()){ labels.push(String(cur.getFullYear())); cur.setFullYear(cur.getFullYear()+1); }
      }
      return labels;
    }

    async function fetchRows(){
      const qs = new URLSearchParams({
        from: $('#from').value, to: $('#to').value,
        facility: (facilityFilter==='all' ? '' : facilityFilter)
      }).toString();
      const res = await fetch("{% url 'api_checkins' %}?"+qs);
      const data = res.ok ? await res.json() : [];
      // คาดหวัง: { ts, session_date, facility, action?: 'in'|'out' }
      return data.map(r => ({ ...r, action: r.action || (r.facility==='pool' ? 'in' : 'in') }));
    }

    async function load(){
      const q = ($('#q').value||'').toLowerCase();
      const raw = await fetchRows();

      rows = raw.filter(r => {
        const name = (FAC_NAME[r.facility]||r.facility).toLowerCase();
        return !q || name.includes(q);
      });

      renderCountsAndTable();
      renderChart();
      updateBigBox();
    }

    function updateTableHeader(){
      const thead = $('#thead');
      const headText = $('#tableHeadText');
      if (facilityFilter === 'pool'){
        thead.innerHTML = '<tr><th>เวลาเข้า</th><th>เวลาออก</th><th>วันที่ (session)</th><th>สนาม</th></tr>';
        headText.textContent = 'เวลาเข้า   เวลาออก   วันที่ (session)   สนาม';
      } else {
        thead.innerHTML = '<tr><th>เวลา</th><th>วันที่ (session)</th><th>สนาม</th></tr>';
        headText.textContent = 'เวลา     วันที่ (session)     สนาม';
      }
    }

    function renderCountsAndTable(){
      updateTableHeader();
      const tb = $('#table tbody'); tb.innerHTML='';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        if (facilityFilter === 'pool'){
          tr.innerHTML = `<td>${r.action==='in' ? fmtTime(r.ts) : '-'}</td>
                          <td>${r.action==='out'? fmtTime(r.ts) : '-'}</td>
                          <td>${r.session_date}</td>
                          <td>${FAC_NAME[r.facility]||r.facility}</td>`;
        }else{
          tr.innerHTML = `<td>${fmtTime(r.ts)}</td>
                          <td>${r.session_date}</td>
                          <td>${FAC_NAME[r.facility]||r.facility}</td>`;
        }
        tb.appendChild(tr);
      });

      const c = countByFacility(rows);
      $('#st-outdoor').textContent = c.outdoor;
      $('#st-badminton').textContent = c.badminton;
      $('#st-pool').textContent = c.pool;
      $('#st-track').textContent = c.track;
      $('#st-total').textContent = c.total;
    }

    function countByFacility(list){
      const c = { outdoor:0, badminton:0, pool:0, track:0 };
      list.forEach(r => { if (c[r.facility]!==undefined) c[r.facility]++; });
      return { ...c, total: c.outdoor+c.badminton+c.pool+c.track };
    }

    function updateBigBox(){
      const title = facilityFilter==='all' ? 'สนามทั้งหมด' : (FAC_NAME[facilityFilter]||'สนาม');
      $('#bigbox').firstChild.nodeValue = ' ' + title + ' ';
      const c = countByFacility(rows);
      $('#bigcount').textContent = facilityFilter==='all' ? c.total : (c[facilityFilter]||0);
    }

    function renderChart(){
      const ctx = $('#chart').getContext('2d');
      if(chart) chart.destroy();

      const timeMode = $('#timeMode').value;
      const from = $('#from').value, to = $('#to').value;

      // 1) “ทั้งหมด” → PIE
      if (facilityFilter === 'all'){
        const c = countByFacility(rows);
        chart = new Chart(ctx,{
          type: 'pie',
          data:{
            labels: [FAC_NAME.outdoor, FAC_NAME.badminton, FAC_NAME.pool, FAC_NAME.track],
            datasets:[{ data:[c.outdoor,c.badminton,c.pool,c.track],
                        backgroundColor:[COLORS.outdoor,COLORS.badminton,COLORS.pool,COLORS.track] }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{ legend:{ position:'right', labels:{ usePointStyle:true } } }
          }
        });
        return;
      }

      // 2) สนามเฉพาะ → กราฟเวลาตามโหมด
      const labels = sortedLabels(timeMode, from, to);
      const dataIn  = new Array(labels.length).fill(0);
      const dataOut = new Array(labels.length).fill(0);

      // นับตาม bucket
      rows.forEach(r=>{
        const d = new Date(r.ts);
        const key = bucketKey(d, timeMode);
        const idx = labels.indexOf(key);
        if (idx === -1) return;
        if (facilityFilter === 'pool'){
          (r.action === 'out' ? dataOut : dataIn)[idx] += 1;
        }else{
          dataIn[idx] += 1; // สนามอื่นนับ “เข้า” อย่างเดียว
        }
      });

      // วาด
      if (facilityFilter === 'pool'){
        chart = new Chart(ctx,{
          type:'bar',
          data:{
            labels,
            datasets:[
              { label:'เข้า (Check-in)', data:dataIn,  backgroundColor:COLORS.pool },
              { label:'ออก (Check-out)', data:dataOut, backgroundColor:'#5bc0b7' }
            ]
          },
          options:{
            responsive:true, maintainAspectRatio:false,
            scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } },
            plugins:{ legend:{ position:'top' } }
          }
        });
      } else {
        const color = COLORS[facilityFilter] || '#888';
        chart = new Chart(ctx,{
          type:'bar',
          data:{ labels, datasets:[{ label:`จำนวนเข้าใช้ (${labelForMode(timeMode)})`, data:dataIn, backgroundColor:color }] },
          options:{
            responsive:true, maintainAspectRatio:false,
            scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } },
            plugins:{ legend:{ display:true } }
          }
        });
      }
    }

    function labelForMode(m){
      if(m==='hour') return 'รายชั่วโมง';
      if(m==='day')  return 'รายวัน';
      if(m==='month')return 'รายเดือน';
      return 'รายปี';
    }

    // ===== Export =====
    function rowsForExport(){
      const map = new Map(); // key: date|facility
      rows.forEach(r=>{
        const key = `${r.session_date}|${r.facility}`;
        map.set(key,(map.get(key)||0)+1);
      });
      const arr = [];
      for(const [k,n] of map){
        const [d,f] = k.split('|');
        arr.push({ 'วันที่ (session)': d, 'ชื่อสนาม': (FAC_NAME[f]||f), 'จำนวนคนเข้าใช้': n });
      }
      arr.sort((a,b)=>a['วันที่ (session)'].localeCompare(b['วันที่ (session)'])
        || a['ชื่อสนาม'].localeCompare(b['ชื่อสนาม']));
      return arr;
    }

    $('#btnExcel').addEventListener('click', ()=>{
      const ws = XLSX.utils.json_to_sheet(rowsForExport());
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Counts');
      XLSX.writeFile(wb, `checkins_${$('#from').value}_${$('#to').value}${facilitySuffix()}.xlsx`);
    });
    $('#btnPDF').addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({orientation:'p', unit:'pt', format:'a4'});
      const data = rowsForExport();
      doc.setFont('Helvetica',''); doc.setFontSize(12);
      doc.text(`รายงานผู้เข้าใช้สนามกีฬา (ช่วง ${$('#from').value} - ${$('#to').value})`, 40, 40);
      if (facilityFilter!=='all') doc.text(`สนาม: ${FAC_NAME[facilityFilter]}`, 40, 58);
      const head = [['วันที่ (session)','ชื่อสนาม','จำนวนคนเข้าใช้']];
      const body = data.map(r=>[r['วันที่ (session)'], r['ชื่อสนาม'], r['จำนวนคนเข้าใช้']]);
      doc.autoTable({ head, body, startY:(facilityFilter==='all'?60:78), styles:{ fontSize:10 } });
      doc.save(`checkins_${$('#from').value}_${$('#to').value}${facilitySuffix()}.pdf`);
    });
    $('#btnDoc').addEventListener('click', async ()=>{
      const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, HeadingLevel } = docx;
      const arr = rowsForExport();
      const head = ['วันที่ (session)','ชื่อสนาม','จำนวนคนเข้าใช้']
        .map(t=>new TableCell({ children:[new Paragraph({text:t})] }));
      const trs = [new TableRow({children:head})];
      arr.forEach(r=>{
        trs.push(new TableRow({children:[
          new TableCell({children:[new Paragraph(String(r['วันที่ (session)']))]}),
          new TableCell({children:[new Paragraph(String(r['ชื่อสนาม']))]}),
          new TableCell({children:[new Paragraph(String(r['จำนวนคนเข้าใช้']))]}),
        ]}));
      });
      const table = new Table({ width:{size:100,type:WidthType.PERCENT}, rows:trs });
      const doc = new Document({ sections:[{ children:[
        new Paragraph({ text:'รายงานผู้เข้าใช้สนามกีฬา', heading:HeadingLevel.HEADING_1 }),
        new Paragraph(`ช่วง ${$('#from').value} - ${$('#to').value}${facilityFilter==='all'?'':(' · '+FAC_NAME[facilityFilter])}`),
        table
      ]}]});
      const blob = await Packer.toBlob(doc);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `checkins_${$('#from').value}_${$('#to').value}${facilitySuffix()}.docx`;
      a.click();
    });
    $('#btnPrint').addEventListener('click', ()=>window.print());
    function facilitySuffix(){ return facilityFilter==='all' ? '' : `_${facilityFilter}`; }

    // Events
    $('#from').addEventListener('change', load);
    $('#to').addEventListener('change', load);
    $('#timeMode').addEventListener('change', load);
    $('#q').addEventListener('input', ()=>load());
    $$('#chips .chip').forEach(ch=>ch.addEventListener('click',()=>{
      $$('#chips .chip').forEach(x=>x.classList.remove('selected'));
      ch.classList.add('selected');
      facilityFilter = ch.dataset.k;
      load();
    }));
    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>